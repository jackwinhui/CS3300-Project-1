<html>

<head>
	<script src="https://d3js.org/d3.v7.min.js"></script>
	<style>
		.gridlines line {
			stroke : grey;
		}

		.gridlines .domain {
			stroke: none;
		}

		.title {
			font-style: bold;
			font-size: 40px;
			font-family: "Copperplate", fantasy;
		}

		.subtitle {
			font-style: bold;
			font-size: 25px;
			font-family: "Copperplate", fantasy;
		}


		.small {
			font-size: 25px;
			font-family: "Copperplate", fantasy;
		}

		svg {
			background-size: 1200px 800px;
			background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('./marvel.png');
		}
		label {
			font-color: white;
		}
	</style>
</head>
<svg height=800 width=1200 style="border:1px solid black">
</svg>
<script>
	const svg = d3.select("svg");
	const width = svg.attr("width");
	const height = svg.attr("height");
	const margin = { top: 150, right: 100, bottom: 100, left: 150 };
	const chartWidth = width - margin.left - margin.right;
	const chartHeight = height - margin.top - margin.bottom;
	let annotations = svg.append("g").attr("id", "annotations");
	let chartArea = svg.append("g").attr("id", "points")
		.attr("transform", `translate(${margin.left},${margin.top})`);

	d3.csv("./mcu_box_office.csv", d3.autoType).then(
		(data) => {
			console.log(data)
			const timeParser = d3.timeParse('%m/%d/%Y'); //m/d/yyyy
			data.forEach(d => { d['worldwide_box_office'] = Number(parseFloat(d['worldwide_box_office'].replace(/,/g, ''))); });
			data.forEach(d => { d['production_budget'] = Number(parseFloat(d['production_budget'].replace(/,/g, ''))); });
			data.forEach(d => { d['release_date'] = timeParser(d['release_date']); });

			//x-axis with Date
			const dateExtent = d3.extent(data, d => d['release_date']);
			const dateScale = d3.scaleTime()
				.domain(dateExtent)
				.range([0, chartWidth]);
			let bottomAxis = d3.axisBottom(dateScale);
			annotations.append("g")
				.attr("class", "x axis")
				.attr("transform", `translate(${margin.left},${chartHeight + margin.top + 10})`)
				.style("color", "white")
				.call(bottomAxis);

			//y-axis with boxOffice - productionBudget
			const boxOfficeExtent = d3.extent(data, d => (d['worldwide_box_office'] - d['production_budget']) / 1000000);
			const boxOfficeScale = d3.scaleLinear().domain(boxOfficeExtent).range([chartHeight, 0]);
			let leftAxis = d3.axisLeft(boxOfficeScale);
			annotations.append("g")
				.attr("class", "y axis")
				.attr("transform", `translate(${margin.left - 10},${margin.top})`)
				.style("color", "white")
				.call(leftAxis);

			//y-axis gridlines
			let leftGridlines = d3.axisLeft(boxOfficeScale).tickSize(-chartWidth - 10).tickFormat("");
			annotations.append('g')
				.attr("class", "gridlines")
				.attr("transform", `translate(${margin.left - 10}, ${margin.top})`)
				.call(leftGridlines);

			//x-axis gridlines
			let bottomGridlines = d3.axisBottom(dateScale).tickSize(-chartHeight - 10).tickFormat("");
			annotations.append('g')
				.attr("class", "gridlines")
				.attr("transform", `translate(${margin.left}, ${chartHeight + margin.top + 10})`)
				.call(bottomGridlines);

			//title
			annotations.append("text")
				.attr("class", "title")
				.attr("text-anchor", "middle")
				.attr("x", margin.left + chartWidth / 2)
				.attr("y", margin.top - 60)
				.text("MARVEL CINEMATIC UNIVERSE")
				.attr("fill", "white");

			//subtitle
			annotations.append("text")
				.attr("class", "subtitle")
				.attr("text-anchor", "middle")
				.attr("x", margin.left + chartWidth / 2)
				.attr("y", margin.top - 30)
				.text("PROFIT PER MOVIE OVER THE YEARS")
				.attr("fill", "white");

			//x-axis label
			annotations.append("text")
				.attr("class", "small")
				.attr("text-anchor", "middle")
				.attr("x", margin.left + chartWidth / 2)
				.attr("y", margin.top + chartHeight + 70)
				.text("Date (Year)")
				.attr("fill", "grey")
				.attr("font-size", "100")
				.attr("font", "100px serif");

			//y-axis label
			annotations.append("text")
				.attr("class", "small")
				.attr("transform", "rotate(270)")
				.attr("text-anchor", "middle")
				.attr("x", -height / 2 - 30)
				.attr("y", margin.left / 2 - 10)
				.text("Worldwide Box Office-Profit")
				.attr("fill", "grey")
				.attr("font-size", "32");

			//y-axis label
			annotations.append("text")
				.attr("class", "small")
				.attr("transform", "rotate(270)")
				.attr("text-anchor", "middle")
				.attr("x", -height / 2 - 30)
				.attr("y", margin.left / 2 + 10)
				.text("(Millions)")
				.attr("fill", "grey")
				.attr("font-size", "32");
			var lineGen = d3.line()
								.x(d => dateScale(d.release_date))
								.y(d => boxOfficeScale((d['worldwide_box_office'] - d['production_budget']) / 1000000));
			chartArea.append("path")
					 .datum(data)
					 .attr("class","line")
					 .attr("fill","none")
					 .attr("stroke","white")
					 .attr("stroke-width",6)
					 .attr("d",lineGen);
			d3.select("svg")
		        .selectAll("circle")
		        .data(data)
		        .join("circle")
		        .attr("cx", d => dateScale(d["release_date"]))
		        .attr("cy", d => boxOfficeScale((d["worldwide_box_office"]-d["production_budget"])/ 1000000))
		        .attr("r", 8)
		        .attr("transform", `translate(${margin.left},${margin.top})`)
		        .attr("fill", "white");
		    let mouseGroup = chartArea.append("g");
		    let xMarker = mouseGroup.append("line")
		    						.attr("id","xMarker")
		    						.attr("fill","none")
		    						.attr("stroke","white")
		    						.attr("stroke-width",1)
		    						.attr("y1",0)
		    						.attr("y2",chartHeight+20)
		    						.attr("visibility","hidden");
		    let valueMarker = mouseGroup.append("circle")
		    							.attr("id","valueMarker")
		    							.attr("stroke","white")
		    							.attr("stroke-width",2)
		    							.attr("r",10)
		    							.attr("visibility","hidden");
		    let label = mouseGroup.append("text")
		    					  .attr("id","label")
		    					  .attr("visibility","")
		    					  .attr("class","label");
		    let activeRegion = mouseGroup.append("rect")
		    						     .attr("id","activeRegion")
		    						     .attr("width",chartWidth+100)
		    						     .attr("height",chartHeight+100)
		    						     .attr("fill","none")
		    						     .attr("pointer-events","all");
		    activeRegion.on("mouseover",function(){
		    	xMarker.attr("visibility","");
		    	valueMarker.attr("visibility","");
		    	label.attr("visibility","");
		    });
		    activeRegion.on("mouseout",function(){
		    	xMarker.attr("visibility","hidden");
		    	valueMarker.attr("visibility","hidden");
		    	label.attr("visibility","hidden");
		    });
		    let findDate = d3.bisector(d => d.release_date).right;
		    activeRegion.on("mousemove",function(evt){
		    	let location = d3.pointer(evt);
		    	let x = location[0];
		    	let xDate = dateScale.invert(x);
		    	let index = findDate(data,xDate);
		    	let d = data[index];
		    	let xPos = dateScale(d['release_date']);
		    	let yPos = boxOfficeScale((d['worldwide_box_office'] - d['production_budget']) / 1000000);
		    	xMarker.attr("x1",xPos).attr("x2",xPos);
		    	valueMarker.attr("cx",xPos).attr("cy",yPos);
		    	let txt = d['movie_title']
		    	label.text(txt)
		    	label.attr("x",xPos).attr("y",yPos - 30).attr("text-anchor","end").attr("hidden","");
		    });
		})
</script>

</html>